<html>
<head> 
<script src="http://motoki.local/socket-io/socket.io.js"></script> 
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script> 
<script>
  //{{{ messageBoad
  messageBoad = function(id){
    var messages      = [],
        _id           = id,
        formatMessage = function (msg) {return msg.sessionId + " : " + msg.data + "<br/>"};
    return {
        add : function (msg) {messages.push(msg);
                              $(_id).append(formatMessage(msg) + "<br/>").css('color','red');}
    }
  };
  //}}} 
  //{{{displayStatus
  displayStatus = function(id){
    var _id = id;
    return {
      connect    : function () {$(_id).text('connecting..').css('color','blue')},
      disconnect : function () {$(_id).text('disconnected').css('color','red')},
      setId      : function (id) {_id = id}}
  };
  //}}}

  var socket     = new io.Socket('motoki.local',{port:8000}), 
      dispStatus = new displayStatus('div.#connect_status'),
      msgBoad    = new messageBoad('div.#message_boad');

  socket.connect();
  socket.on('connect',    onConnect);
  socket.on('disconnect', onDisconnect);
  socket.on('message',    onMessage);

  $(function(){
    $('input#send_button').bind('click', sendMessage);;
  });
  //{{{sendMessage
  function sendMessage()
  {
      var msg  = {"type"  : 'string',
                  "color" : 'red',
                  "data"  : $('input#send_body').val()};
      console.log(typeof msg);
      socket.send(msg);
      // socket.send($('input#send_body').val());
  }
  //}}} 
  function onConnect()
  {
      log('onConnect');
      dispStatus.connect();
  }
  function onDisconnect()
  {
      log('onDisconnect');
      dispStatus.disconnect();
  }
  function onMessage(msg)
  {
      log('onMessage');
      msgBoad.add($.parseJSON(msg));
  }
  //{{{ msgToJsonString
  function msgToJsonString(msg)  {
    aa()
      return  '{"type":"'+msg.type +'",'+
                '"color":"'+msg.color +'",'+
                '"data":"'+msg.data +'"}';
  }
  //}}} 
  //{{{log
  function log(msg)
  {
      if (console) {
            console.log(msg);
      }
  }
  //}}}
</script>
</head>
<body>
  <div id='connect_status'>choge</div>
  color : <select id='send_body' type="select">
    <option value='blue'/>blue</option>
    <option value='green'/>green</option>
    <option value='red'/>red</option>
        </select>
  message : <input id='send_body' type="text"/>
  <input type="button" id='send_button'/>
  <hr/>
  <div id='message_boad'></div>
  <hr/>
</body>
</html>
